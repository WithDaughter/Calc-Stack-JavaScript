<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>스택 계산기</title>
    <style>
        body {
            font-family: D2Coding, 'Nanum Gothic', sans-serif;
            font-size: 24px;
            color: white;
            background: black;
        }
    </style>
</head>
<body>
<script>
    const debug = msg => document.write(`<div>${msg}</div>`)

    class Lexer {
        constructor(src) {
            this.tokens = src.split('')
        }

        isOp(op) {
            return '+-*/()'.includes(op)
        }

        peekToken() {
            if (this.isOp(this.tokens[0]))
                return this.tokens[0]
            else
                return Number(this.tokens[0])
        }

        getToken() {
            const token = this.tokens.shift()
            if (this.isOp(token))
                return token
            else
                return Number(token)
        }
    }

    const isOp = op => '+-*/'.includes(op)

    toPostfix = src => {
        const lexer = new Lexer(src)
        const postfixQueue = []
        const opStack = []
        const isOpMultiOrDiv = op => op === '*' || op === '/'
        const isLParenthesis = op => op === '('
        const isRParenthesis = op => op === ')'
        const canStackPop = op => {
            if (isOpMultiOrDiv(op))
                return isOpMultiOrDiv(opStack.at(-1))
            else
                return !isLParenthesis(opStack.at(-1))
        }
        let token = lexer.peekToken()
        while (token) {
            if (isLParenthesis(token))
                opStack.push(lexer.getToken())
            else if (isRParenthesis(token)) {
                while (opStack.length && !isLParenthesis(opStack.at(-1)))
                    postfixQueue.push(opStack.pop())
                opStack.pop()
                lexer.getToken()
            } else if (isOp(token)) {
                while (opStack.length && canStackPop(token))
                    postfixQueue.push(opStack.pop())
                opStack.push(lexer.getToken())
            } else
                postfixQueue.push(lexer.getToken())
            token = lexer.peekToken()
        }
        while (opStack.length) {
            postfixQueue.push(opStack.pop())
        }
        return postfixQueue
    }

    const calcInfix = (op, left, right) => {
        switch (op) {
            case '+':
                return left + right
            case '-':
                return left - right
            case '*':
                return left * right
            case '/':
                return left / right
        }
    }

    const evalPostfixQueue = postfixQueue => {
        const stack = []
        for (const token of postfixQueue) {
            if (isOp(token)) {
                const right = stack.pop()
                const left = stack.pop()
                const val = calcInfix(token, left, right)
                stack.push(val)
            } else
                stack.push(token)
        }
        return stack.pop()
    }

    const calc = src => {
        const postfixQueue = toPostfix(src)
        return evalPostfixQueue(postfixQueue)
    }

    ;(_ => {
        src = '2-(3+2)-2'
        try {
            val = calc(src)
            debug(val)
        } catch (e) {
            debug(e)
        }
    })()
</script>
</body>
</html>